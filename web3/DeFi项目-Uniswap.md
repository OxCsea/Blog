# Uniswap

## 学习路线

**一、基础认知**

1. **Uniswap 的定位与角色**
   1. 去中心化交易所（DEX）
   2. 自动化做市商（AMM）的开创者
   3. 无需订单簿的流动性撮合逻辑
2. **核心概念**
   1. AMM（Automated Market Maker）
   2. 流动性池（Liquidity Pool）
   3. 恒定乘积公式（x * y = k）
   4. LP Token 与流动性提供者收益机制
   5. 无常损失（Impermanent Loss）

**二、版本演进**

**三、生态与衍生玩法**

1. **周边协议与集成**
   1. Uniswap 在 DeFi 生态的位置（与 Curve、Balancer、SushiSwap 的关系）
   2. Aggregator（如 1inch、Matcha）如何利用 Uniswap
2. **收益策略**
   1. 被动 LP 与主动 LP
   2. 集中流动性策略（窄区间 vs 宽区间）
   3. 结合借贷平台的复合策略（如 LP Token 抵押）
3. **治理与代币经济学**
   1. UNI 代币分配与治理权
   2. 治理在参数调整（费率、激励）中的作用

**四、技术原理深入**

1. **恒定乘积公式数学推导**
2. **价格预言机功能（V2、V3）**
3. **智能合约结构与安全性考量**

**五、未来趋势**

1. V4 展望（Hook、流动性层改造）
2. Uniswap 在多链和 Layer 2 的布局

## 背景

传统中心化交易所的问题

- 需要托管资金 → 有被盗、冻结风险
- 需要订单簿撮合 → 流动性不足时交易体验差

Uniswap 的目标

- **去中心化交易（DEX）**
- **自动化做市（AMM）** → 不依赖订单簿
- **任何人可提供流动性** 并赚取手续费

## 版本

1. **V1**（2018）
   1.  **核心机制**：首次引入 AMM（自动做市商）模型，使用 x * y = k 恒定乘积公式。

   2.  **交易方式**：只能通过 ETH 作为中间资产（ERC20 之间的交易需要先 ERC20→ETH→ERC20）。单一 ETH-ERC20 交易对模型。

   3.  **优点**：实现了去中心化、无需许可的代币交易。

   4.  **缺点**：路径固定、交易成本高、滑点大。
2. **V2**（2020）
   1.  **主要升级**：

   2. **任意 ERC20 对**ERC20-ERC20 直兑：支持 ERC20 直接和 ERC20 交易，无需经过 ETH。
   3. **价格预言机**：引入时间加权平均价格（TWAP）。
   4. **闪电交换**（Flash Swap）：允许先拿走资产、后付款（或归还）。
   5.  **优势**：LP Token 标准化，流动性池更灵活、交易路径可优化。

   6.  **局限**：资金利用率低（大部分资金闲置在非当前价格区间）。
3. **V3**（2021）
   1.  **主要升级**：

   2. **集中流动性（Concentrated Liquidity）**：流动性提供者可指定价格区间，提高资金效率（资本利用率可提升 4~400 倍）。
   3. 不同费率档：0.05%、0.3%、1%，给 LP 更多定价选择。
   4. **更精准的价格预言机**。
   5.  **优势**：资金利用率高、收益潜力更大、对专业 LP 友好，LP 角色从被动变主动。

   6.  **局限**：管理难度高、无常损失变化与管理策略、需要主动调整仓位。

## 定位

1. 去中心化交易所（DEX）

- Uniswap 是一个运行在以太坊等区块链上的去中心化交易所。
- 与中心化交易所（CEX，比如 Binance）不同，它**不托管用户资金**，所有交易都在链上、通过智能合约完成。

2. 自动化做市商（AMM）的开创者

- 在 2018 年上线时，Uniswap 开创了 **AMM 模型**，替代传统的 **订单簿**（order book）撮合交易方式。
- AMM 不需要买卖双方直接匹配订单，而是依赖一个**流动性池**，用算法自动计算价格和撮合交易。

3. 无需订单簿的流动性撮合逻辑

- 用户交易时，不是直接跟另一个交易者成交，而是与**流动性池**交互。
- 流动性池中储备着两种代币（比如 ETH/USDC），价格由池中资产的比例自动决定。

## 核心概念

1. 做市商（Market Maker）是指在交易市场中，持续为某个资产提供买入报价（Bid）和卖出报价（Ask）的参与者。

- 在传统金融中，做市商可以是大型券商、交易公司（如 Citadel、Jane Street），他们通过挂单保证市场一直有人可以交易。
- 在加密市场中，做市商既可以是中心化交易所的专业做市团队，也可以是 AMM 协议中任何存入资金的流动性提供者（LP）。

为什么需要做市商

> **保证流动性**：如果没有做市商，当你想卖掉一笔资产时，可能没有人愿意立刻买，这会造成交易延迟或价格大幅波动。
>
> **降低交易成本**：做市商通过持续挂单，减少买卖双方之间的价差（Bid-Ask Spread），让价格更接近“真实价值”。
>
> **维持市场稳定**：价格不会因为少量交易而剧烈波动。

2. AMM（Automated Market Maker）

> 在 AMM 模型中，“做市商”不再是一个个专业交易员，而是一个 **智能合约 + 流动性提供者资金** 组合。

- **自动化做市商**：用数学公式而不是人工挂单来提供流动性。
- Uniswap V1/V2 用的公式是：**x \* y = k** 其中：
  - x = 池中代币 A 数量
  - y = 池中代币 B 数量
  - k = 常数（不变）
- 交易改变了 x 和 y，但 k 必须保持不变，因此价格会自动调整。

3. 流动性池（Liquidity Pool）

- 每个交易对（如 ETH/USDC）都有一个智能合约池。
- 用户可以存入等价值的两种资产（比如 1 ETH 和 2000 USDC）来**提供流动性**。
- 这些资产被用来给交易者换币，交易者支付的手续费会分给流动性提供者。

4. 恒定乘积公式（x * y = k）

- 是 Uniswap V1/V2 的定价核心。
- **原理**：池中两种资产的乘积保持不变，所以交易量越大，对价格的冲击（滑点）越大。
- 举例：
  - 初始：池中有 10 ETH 和 20,000 USDC → k = 10 × 20,000 = 200,000
  - 有人买 1 ETH → ETH 减少到 9，USDC 增加到 22,222 → 新价格 ETH ≈ 2469 USDC。

5. LP Token 与收益机制

- 当你提供流动性时，会收到 **LP Token**（流动性证明）。
- LP Token 可以随时赎回对应比例的资产+交易手续费收益。
- 收益主要来源：
  - 交易手续费（V2 默认 0.3%）
  - 有时 LP Token 还能在 DeFi 协议中二次质押（Yield Farming）赚额外收益。

6. 无常损失（Impermanent Loss）

- 当池中两种资产的价格比例变化时，LP 的资产价值可能低于直接持有的价值。
- 例如：
  - 你在 ETH/USDC 池中存入 1 ETH + 2000 USDC（ETH 价格 2000）
  - ETH 价格涨到 3000 时，池子会自动再平衡，导致你持有的 ETH 数量减少
  - 最终赎回的资产总价值可能低于直接持有的 1 ETH + 2000 USDC
- 如果交易手续费收益不足以覆盖这种差额，就会亏损。

7. TPS（Transactions Per Second）= 每秒钟系统能处理的交易数量。它是衡量区块链或交易系统**吞吐能力**的关键指标。

1.  参考标准（不同领域差别很大）

2. **比特币 BTC**：约 7 TPS（非常低）
3. **以太坊 ETH（L1）**：约 15–20 TPS（低，容易拥堵）
4. **Solana**：理论峰值 50,000+ TPS（高性能公链）
5. **Visa 支付网络**：理论可达 65,000 TPS（传统金融系统极高）
6.  **高/低判断**

7. 对 **去中心化交易所（DEX）** 而言，> 1,000 TPS 就已经是很高的处理能力。
8. 对 **链下撮合交易所**，可能需要上万 TPS 才算高。
9. 高 TPS 可以降低交易延迟，减少滑点，支持更大交易量。

## 交易机制

### 订单簿机制（Order Book Model）

#### **原理**

订单簿是一种撮合交易的传统模式，由买单（Bid）和卖单（Ask）组成的列表。

**买单**：交易者希望以某个价格购买资产

**卖单**：交易者希望以某个价格出售资产

**撮合逻辑**：交易所将买单与卖单配对，当价格匹配时成交。

- 交易平台维护一个 **订单簿**，记录所有买单（Bid）和卖单（Ask）。
- 每个订单包含价格与数量，比如：“愿意用 100 USDT 买 1 ETH”。

#### 技术架构

核心模块

- **订单簿数据库**：记录每个挂单的价格、数量、时间
- **撮合引擎**：匹配最优的买单与卖单（如价格优先、时间优先）
- **清算与结算模块**：交易完成后进行资金划转

撮合方式

- **限价单（Limit Order）**：用户指定价格和数量，挂在订单簿等待成交
- **市价单（Market Order）**：立即按当前市场最优价格成交

延迟问题 集中式交易所（CEX）能在毫秒级完成撮合，而链上订单簿（如 Serum）受限于区块时间与 Gas 成本，延迟较高。

#### **运作流程**

1. 用户提交买/卖订单，指定价格和数量。
2. 撮合引擎匹配最优价格订单，完成交易。
3. 如果未完全成交，剩余部分挂单等待下一次撮合。

#### **特点**

- 价格由买卖双方的出价和要价形成（供需驱动）。
- 流动性取决于市场参与者的挂单数量和深度。
- 价格发现更直接，但需要做市商不断挂单维持深度。

#### 做市商作用

**（1）提供挂单（Liquidity Provision）**

- 做市商会在不同价格档位挂出买单和卖单，形成**价格深度**。
- 比如，BTC 当前价格 30,000 美元，做市商可能挂：
  - 买单：29,900 / 29,800 / 29,700…
  - 卖单：30,100 / 30,200 / 30,300…

**（2）控制价差（Spread Control）**

- 做市商通过不断调整买卖单的价格，让价差保持很小，吸引交易量。
- 在高波动时期，做市商可能会拉大价差以对冲风险。

**（3）赚取利润**

- **价差套利**：低价买入，高价卖出。
- **做市费**：一些交易所会向做市商返佣。
- **库存管理**：通过对冲策略控制持仓风险。

### AMM 机制（Automated Market Maker）

#### **原理**

- 不依赖传统订单簿，而是通过 **算法公式**（比如 Uniswap 的恒定乘积公式 `x * y = k`）自动定价。

  - > `x`：流动性池中资产 A 的数量
    >
    > `y`：流动性池中资产 B 的数量
    >
    > `k`：恒定乘积，不变

- 交易对的资产存放在 **流动性池（Liquidity Pool）** 中，由流动性提供者（LP）存入等值两种资产。

- 用户与流动性池直接交易，价格会根据交易量和池子中资产比例变化。

#### 技术架构

- **流动性池（Liquidity Pool）**：由 LP（流动性提供者）提供的资产构成
- **智能合约**：负责价格计算、交易撮合、手续费分配
- **LP Token**：代表流动性提供者的份额，可赎回池中资产+交易手续费

#### **运作流程**

1. 流动性提供者（LP）存入等值 Token A 和 Token B。
2. 用户想用 Token A 兑换 Token B，就向池子发送 Token A，自动从池子中按公式兑换 Token B。
3. 交易完成后，池子内两种资产的比例改变，价格随之调整。

#### **特点**

- 价格由公式自动计算，无需撮合引擎。
- 流动性池里总是有买卖方（因为池子中两种资产都有），不存在挂单等待问题。
- 用户支付交易费，分给 LP 作为激励。

### 对比

DeFi更偏向AMM原因：

> **链上效率**：区块链 TPS 与延迟限制使得高频撮合（订单簿）不现实
>
> **资本利用率**：AMM 能让任何人提供流动性并赚取手续费，降低门槛
>
> **长尾资产支持**：订单簿对冷门资产几乎无流动性，AMM 只要有 LP 存资金就可运行

订单簿模式在 CEX（Binance、OKX）和少数高性能链（如 Solana Serum）有优势，因为撮合速度快、深度好。

AMM 模式在以太坊等高 Gas、低 TPS 链上统治地位，因为无需实时撮合。

**混合模式（Hybrid Model）** 已出现，比如 dYdX（链上订单簿 + 做市商）、Curve（稳定币 AMM + 集中流动性）

分析一个 DeFi 协议时，需要判断它的市场定位：

- 高性能公链：订单簿可能可行
- EVM 生态：AMM 更普遍

| 特性       | 订单簿交易                       | AMM 交易                       |
| ---------- | -------------------------------- | ------------------------------ |
| 价格形成   | 买卖双方挂单决定                 | 数学公式自动决定               |
| 撮合方式   | 中心化撮合引擎或链上限价单       | 用户直接与智能合约流动性池交互 |
| 流动性依赖 | 需要足够多的挂单（尤其是做市商） | 依赖流动性池深度               |
| 交易速度   | 撮合和结算可能需要等待           | 即时成交                       |
| 价格稳定性 | 深度好时波动小，深度差时滑点大   | 深度好时滑点小，深度差时滑点大 |
| 复杂度     | 需要订单管理、撮合系统           | 公式简单直接                   |
| 做市商角色 | 主动挂单调整价格                 | 被动提供资金让公式定价         |

## Uniswap V2

### 核心机制

Uniswap V2 是在 V1 基础上的重大升级，核心在于：

1. **支持 ERC-20 / ERC-20 交易对**
   1. V1 只能做 ERC-20 ↔ ETH，V2 允许任意 ERC-20 直接配对交易，例如 USDC/DAI。
   2. ETH 不再是唯一的桥梁资产（虽然 ETH 仍然常用）。
2. **AMM 恒定乘积公式升级**
   1. 核心公式：x⋅y=kx \cdot y = kx⋅y=k
   2. x、y 分别是流动池两种资产的储备量，k 是恒定值。 每次交易会改变 x、y，但保持乘积恒定（扣除手续费）。
   3. 手续费：V2 统一 **0.3%**，全部进入 LP 收益。
3. **价格预言机（TWAP）内置**
   1. V2 提供一个**时间加权平均价格**（Time-Weighted Average Price, TWAP）接口，方便外部 DeFi 协议安全读取价格，减少闪电贷操纵。
4. **闪电交换（Flash Swap）**
   1. 允许你先取走代币再付钱，只要在交易结束前还回（或等值支付），可实现无抵押借币。
   2. 这是很多套利、清算策略的基础。

### 用户交互

在 V2 上，用户有两种主要角色：

1. 交易者（Trader）：直接在 AMM 上用一种代币换另一种代币。

- 优势：去中心化、无需账户、滑点低（在深池中）。
- 劣势：池子浅时滑点大，不适合大额交易。

2. 流动性提供者（Liquidity Provider, LP）

- 存入等值的两种代币到一个池子中，比如 1,000 USDC + 1,000 DAI。
- 获得 **LP Token**（代表你在池子的份额）。
- 收益来源：
  - 0.3% 交易手续费按比例分配。
  - 可能的流动性挖矿奖励（取决于第三方项目）。

### 闪电贷Flash Loan

#### 定义

DeFi 特有的一种“零抵押、超短期”的贷款机制。你可以在同一笔交易（一个区块）内，借出任意数量的资金，并且只要在交易结束前还回本金和利息，就无需任何抵押物。

#### 操作

1. 调用闪电贷函数，向协议（如 Aave、Uniswap）借出资产。
2. 在同一交易中使用这些资产去做套利、清算、抵押置换等操作。
3. 在交易的最后一步，把本金 + 利息（闪电贷费率）还给协议。
4. 如果还不回，整个交易会被回滚，相当于没发生过。

> **为什么能零抵押？** 因为交易是原子化的（atomic），要么全部执行，要么全部回滚，协议不会承担风险。

时间窗口

在以太坊（或任意区块链）里，交易是按区块打包执行的。 闪电贷要求：借款和还款**必须在同一笔交易（同一个区块内的同一调用链）完成**。 也就是说，这笔交易的执行过程大概是：

1. 借钱（从闪电贷池）
2. 用借来的钱去做套利、清算、操纵价格等操作
3. 把借的钱 + 手续费还回去 如果步骤 3 没有发生，**整个交易就会 revert（回滚）**，状态恢复到执行前，等于啥也没发生。

#### 跨链回滚

如果你在交易过程中，把钱转到了另一条链（比如从以太坊桥到BSC），就没法在同一笔交易中确认另一条链的结果（跨链消息通常要多个区块确认）。 因此，**跨链场景没法直接用闪电贷完成提款**，因为还款必须同区块完成，否则会回滚。你跨链转走资金，等于中断了原链的执行流，借贷合约直接检测到没钱还，就触发回滚。

#### 为什么借款和还款必须在同一笔交易中

这依赖于区块链（特别是以太坊）的 **原子性（Atomicity）** 特性：

- 区块链上的一次交易（transaction）可以包含多步操作（函数调用、合约交互）。
- 这些操作 **要么全部成功，要么全部失败**。
- 如果在交易执行过程中某一步失败，EVM（以太坊虚拟机）会回滚（revert）到交易执行前的状态，就像什么都没发生过。

对于闪电贷来说：

- 借款的合约代码要求 **在函数执行结束前，借到的钱和利息必须全部还回去**。
- 如果没有还清，`require()` 条件会触发，交易就会 **revert**，整个交易作废。
- 作废意味着你借到的钱、做的所有操作、产生的所有转账，全部不算数。

具体做法

关键是 **智能合约调用链** 的执行顺序。

- 你调用闪电贷合约 → 闪电贷合约把钱打给你（或者你的合约）。
- 在同一个函数里，你用借来的钱做套利、清算等操作。
- 在函数结束前，你调用还款逻辑，把本金+手续费还回去。
- 如果没还够，闪电贷合约会 `revert` 整个交易。

 **一个闪电贷交易的流程（单个交易内完成）**：

1. 交易发起人（你）调用闪电贷合约。
2. 闪电贷合约发送资金给你。
3. 你用资金做一些操作（套利、清算等）。
4. 你还钱给闪电贷合约（本金+手续费）。
5. 合约检查资金是否归还 → 如果不够 → 直接回滚整笔交易。

**如果把钱跨链了呢？**

如果你在交易中 **试图把闪电贷资金跨链**，那么：

- 跨链桥的交易只是生成一个事件（event），等待对方链验证。
- 但是在以太坊这一笔交易还没结束，EVM 会检查你有没有还钱。
- 如果你没还，EVM 会直接回滚到 **借款前的状态**，相当于你根本没有“发出”跨链指令（因为它也会被回滚）。

所以不可能通过跨链把闪电贷的钱带走不还——这就是区块链原子性的威力。

## Uniswap V3

### V3的升级

**集中流动性（Concentrated Liquidity）**

- V2：你的流动性是均匀分布在 **0 ~ ∞** 的价格区间。
- V3：你可以选择只在一个价格范围内提供流动性，例如 ETH/USDC 在 1,500 ~ 2,000 美元。
- 好处：资本效率提升，可用同样资金赚取更多手续费收益。
- 风险：如果价格超出范围，你的 LP 不再赚手续费，资金变成单边持仓。

**多费率池（Multiple Fee Tiers）**

- V2：统一 0.3% 手续费。
- V3：提供 0.05%、0.3%、1% 三个费率档，适合不同波动性资产。
- 这让 LP 可以根据资产波动性和风险选择更合适的费率。

**NFT 化 LP 头寸**

- V2：LP Token 是 ERC-20，可互换，代表均匀流动性份额。
- V3：LP 头寸是一个 **NFT**（ERC-721），因为每个 LP 有独特的价格区间设置，无法直接互换。
- 影响：LP 头寸可二级市场交易，但不能像 V2 那样直接合并。

### 集中流动性

#### 背景

**V2 的问题**

- V2 的流动性是全局均匀分布的： 无论价格在 $0.0001 还是 $1,000,000，流动性都会被“铺”在整个价格区间。
- 现实情况： 绝大多数交易都发生在一个很窄的价格区间（比如 ETH/USDC 基本在 $1,000-$3,000 之间波动）。
- 结果： 大量资金“躺”在极端价格区间，**永远不会被用到**，但仍然被算作总流动性的一部分。 → 资本利用率低，LP 收益率偏低。

**V3 的改进**

- LP 可以自己定义资金在哪个价格区间提供流动性，比如 $1500-$2000。
- 数学机制依然是 **常乘公式** $$x \cdot y = k$$，但**只在你设定的区间内**有效。 超出区间时，你的资金会完全变成单一资产，直到价格回到区间才恢复做市。
- 意义：
  - 把资金集中在高成交区 → 提高资金利用率（同样资金赚更多手续费）。
  - 允许 LP 制定差异化策略，比如只做“区间内高频套利”的稳定币对。

**意义**

**V2 全局模式：**

- 资金分布在 $[0, \infty)$。
- 你提供 10 万 USDC + 等值 ETH，大部分时间只有极少部分资金参与交易（价格越远，利用率越低）。

**V3 集中流动性模式：**

- 你设置 $2000$-$2200$。
- 当 ETH 价格在这个区间时，你的 10 万资金几乎 **全部参与交易**，所以你每笔交易分到的手续费更高。

> 这是“设置区间”的本质意义： **用更少的资金，承接更多的交易量，从而放大手续费收益。**

| 特性             | V2 全局均匀流动性    | V3 集中流动性            |
| ---------------- | -------------------- | ------------------------ |
| 资金分布         | 覆盖全区间，低利用率 | LP 可指定区间，高利用率  |
| LP 收益来源      | 手续费分摊给所有资金 | 手续费集中分给区间内资金 |
| 价格区间外表现   | 仍在做市，但很低效   | 资金变单一资产，不再做市 |
| 对冷门区间的影响 | 流动性稳定但浪费     | 冷门区流动性可能不足     |
| 策略灵活度       | 低                   | 高，可定制区间和风险     |

#### 公式

V2的公式：

$$x \cdot y=k·$$

资金覆盖整个价格曲线。

V3 公式在数学上还是恒定乘积，但资金分布是分段的：

价格区间$$[P_a, P_b]$$内，你的流动性会按公式 $$L=\frac{\Delta x}{\frac{\sqrt{P_b} - \sqrt{P_a}}{\sqrt{P_a} \cdot \sqrt{P_b}}}$$

或$$L=\frac{\Delta y}{\sqrt{P_b} - \sqrt{P_a}}$$来计算（取决于你是单边提供 x 还是 y）。

这里的 **L（流动性）** 是核心变量，因为手续费是按 L 分配的。

### 收益预估

假设：

- ETH/USDC 交易对
- 当前价格：1,800 USDC/ETH
- 你选择区间 [1,700, 1,900]
- 提供 10 ETH 价值（5 ETH + 9,000 USDC）
- 日交易量：1,000 万 USDC
- 费率：0.3%
- 你区间内的资金占比：5%

那么：

- 日手续费总额 = 10,000,000×0.003=30,000 USDC
- 你份额收益 = 30,000×5%=1,500 USDC / 天

相比 V2 覆盖全区间，**同样资金的收益可提高 5-20 倍**。

#### 流动性荒漠

集中流动性导致的“流动性荒漠”现象：

- 大多数 LP 会把钱放在“热区”（比如 ETH 现价附近）。
- 冷门价格区间（远离现价）可能几乎没人做市 → 成交滑点变大。
- 滑点大 → 用户不愿意在这个区间成交 → 交易量更少 → 更没人做市（恶性循环）。

**Uniswap 的解决办法：**

- 市场自己会用手续费率（Fee Tier）引导流动性分布。 比如：
  - 热区手续费低（0.05% 或 0.3%） → 鼓励交易量。
  - 冷区手续费高（1%） → 吸引愿意承担风险的 LP 过去赚高费率。
- 套利者的存在会“连接”区间：价格越偏离热区，套利机会越多，也会吸引流动性进入。

### 风险评估

区间外资金闲置，如果 ETH 价格跌到 1,650：

- 你的 ETH 都变成 USDC
- 手续费收入暂停（区间外无交易）
- 你变成单边持仓（类似定投）

所以 V3 LP 策略不仅是“放钱”，而是**持续动态调仓**。

以前 V2 LP 是“被动收益”，V3 LP 是“主动策略”。

如果你不做动态调仓，收益可能比 V2 还低。

专业玩家用脚本或 Keeper 网络自动调整区间。

### 套利

1. 集中流动性套利

- 如果市场价格跳出区间，你可以快速移动区间重新捕捉手续费。
- 成本：Gas + 头寸重新铸造成本。

2. 费率选择策略

- 波动大 → 高费率（0.3% 或 1%）
- 稳定币对 → 低费率（0.05%），吸引更多交易量。

3. V3 vs V2 套利

- 有时同一对资产在 V2、V3 或其他 AMM（如 SushiSwap、Curve）价格不一致，可以做跨池套利。
- V3 因流动性分布不均，更容易出现短时价格偏差。

案例：如果你现在想做 ETH/USDC LP：

1. 先用历史价格数据（可用 Dune Analytics）找出最常交易的区间。
2. 选定一个范围，比如 ±5%。
3. 计算你在这个范围的**日均手续费收益**。
4. 监控价格，一旦快出区间就手动或自动调整。

## 用途

**集中流动性（Concentrated Liquidity）**

- V2：你的流动性是均匀分布在 **0 ~ ∞** 的价格区间。
- V3：你可以选择只在一个价格范围内提供流动性，例如 ETH/USDC 在 1,500 ~ 2,000 美元。
- 好处：资本效率提升，可用同样资金赚取更多手续费收益。
- 风险：如果价格超出范围，你的 LP 不再赚手续费，资金变成单边持仓。

**多费率池（Multiple Fee Tiers）**

- V2：统一 0.3% 手续费。
- V3：提供 0.05%、0.3%、1% 三个费率档，适合不同波动性资产。
- 这让 LP 可以根据资产波动性和风险选择更合适的费率。

**NFT 化 LP 头寸**

- V2：LP Token 是 ERC-20，可互换，代表均匀流动性份额。
- V3：LP 头寸是一个 **NFT**（ERC-721），因为每个 LP 有独特的价格区间设置，无法直接互换。
- 影响：LP 头寸可二级市场交易，但不能像 V2 那样直接合并。z
- DEX 间的价格套利
- 清算抵押品（如在 Maker、Aave 上）
- 临时操纵预言机价格（攻击行为）

### 策略应用

1. 套利

- **跨池套利**：不同池子间的价格差，例如 USDC/DAI 在 Uniswap 比 Sushiswap 便宜。
- **跨平台套利**：AMM 与 CEX（中心化交易所）之间套利。
- **闪电贷套利**：用 V2 的 flash swap 获取资金，零本金参与套利。

2. 收益优化

- 将 V2 的 LP Token 存入 Yearn、Convex 等聚合器获得额外收益。
- 结合借贷协议（Aave、Compound）进行杠杆 LP（提高收益，但放大无常损失风险）。

3. 抢跑与 MEV 策略

- 监控链上内存池（Mempool），抢在别人之前套利或清算（技术门槛高）。

#### 抢跑与MEV策略

**定义**

- **抢跑（Front-running）**：提前看到别人将要发出的交易，自己先发一笔类似交易以抢占价格变动的收益。
- **MEV**：矿工（或区块打包者）能够通过调整交易顺序、插单、夹单等方式获取的最大可提取价值。

#### **常见 MEV 策略**

- **三明治攻击（Sandwich Attack）**
  - > 区块链的交易是公开的，在被打包进区块前会在内存池（mempool）中排队。MEV 机器人监听 mempool，识别大额交易，然后用更高的 Gas 费插队到目标交易的前后，形成“三明治”

  - 看到用户要用大额买单推高某币价。
  - **Front-run（夹心上片）**：在用户交易之前，攻击者自己先买入（推高价格）
  - **User trade（夹心馅）**：用户的大单买入进一步推高价格
  - **Back-run（夹心下片）**：攻击者在用户交易后立即卖出，赚取价差
- **清算抢跑**：在借贷协议有抵押品可清算时，抢先触发清算赚取奖励。
- **跨池套利**：利用不同池之间的价格差，调换交易顺序以提高利润。

#### TWAP 预言机（Time-Weighted Average Price）与攻击原理

**TWAP**

- 是一种按时间加权的平均价格，用于减少单次价格波动的干扰。
- 在 Uniswap V2 中，TWAP 是通过累计价格（price cumulative）+ 时间戳计算的。

**机制**

- 每个区块记录一次价格累计值（price_cumulative_last）。
- 读取 TWAP 时，取两个时间点的累计值差，除以时间间隔。

**攻击原理**

- 如果项目直接用 Uniswap V2 的现价（spot price）作为喂价，就会被闪电贷+大额交易拉盘/砸盘操纵。
  - 因为 AMM 是按储备比例定价，没有订单簿保护，单笔交易可以直接改价格，所以 **现价预言机极易被操纵**。
  - **现价（spot price）**就是链上 AMM 池子里此刻的价格，比如 Uniswap V2 用 price=reservey/reservex。如果你直接拿这个价格作为预言机喂价给借贷、清算等逻辑，风险很大，因为它可以瞬间被大额交易操纵。
  - 思路：
    - 攻击者先闪电贷一大笔资金
    - 在 Uniswap V2 池里买入或卖出某个代币，把价格往极端方向推
    - 借贷协议读取池子的现价（已经被操纵）
    - 攻击者利用这个错误喂价，去做低价买入 / 高价卖出 / 清算获利
    - 在同一笔交易里再把池子价格恢复正常，并归还闪电贷
- 如果 TWAP 时间窗口太短（如几秒），攻击者可以在短窗口内用大额闪电贷交易改变均价。
- 解决办法：
  - 增加时间窗口（如 30 分钟~1 小时）
  - 使用多来源预言机（Chainlink + DEX TWAP）

#### 收益与无常损失

**LP 收益**

- 收益来源：交易手续费（Uniswap V2 默认 0.3%）+ 部分项目会额外激励（代币奖励）。
- 收益计算：
- 收益=手续费收入+代币奖励收益 = 手续费收入 + 代币奖励收益=手续费收入+代币奖励

**无常损失（Impermanent Loss）**

- 指当你作为 LP 提供的两种资产价格发生变化时，你的持仓总价值相对于直接持有这两种资产会减少。
- 原因：AMM 会强制让你的资产比例保持 50:50（按价值），价格变化会导致“高涨的资产被卖出、低跌的资产被买入”，错过最大涨幅。

**无常损失公式（两资产 50:50 情况）** 假设价格变化倍数为

$$r = P_{\text{new}} / P_{\text{old}} \\ IL= \frac{2\sqrt{r}}{1 + r} - 1$$

举例：

- 如果 r = 2（价格翻倍），IL ≈ -5.72%
- 如果 r = 0.5（价格减半），IL 也是 -5.72%
- 如果价格变化越大，IL 越大。

## 生态与衍生玩法

### 周边协议与集成

#### **Uniswap 在 DeFi 生态的位置**

- **Uniswap**：通用 AMM（自动做市商），适配各种代币对，强调去中心化、许可开放。
- **Curve**：专精于稳定币和锚定资产（如 USDC/USDT、stETH/ETH）的低滑点交易，核心公式是 **StableSwap**，采用特殊的恒定和曲线。对价格偏差小的资产有超低滑点优势。
- **Balancer**：类似加权版 Uniswap，支持自定义权重池（如 80% WETH + 20% BAL，不仅限 50/50），可做指数基金型池子。适合多资产池、指数型策略。
- **SushiSwap**：最初是 Uniswap V2 的 fork，加了收益农场（LP Token 质押挖矿），早期靠代币激励吸引流动性，现在也有 Kashi 借贷、Trident AMM 等扩展功能。更多是社区驱动，功能多元化。

**生态关系**

- Curve 在稳定币兑换效率高 → 聚合器会在稳定币对时优先调用 Curve。
- Uniswap 在长尾资产（小币）交易占优势 → 新币、长尾代币主要依赖 Uniswap。
- Balancer 对指数型资金池（比如 DeFi 蓝筹 80% ETH + 20% 其他）有优势。
- SushiSwap 主要在社区运营和额外激励上有竞争力。

#### **Aggregator 如何利用 Uniswap**

> [Aggregator] → 调用 → [Uniswap / Curve / Balancer / SushiSwap] → 执行交易

- **Aggregator**（聚合器）如 **1inch、Matcha、Paraswap** 会：
  - 同时查询多个 DEX（Uniswap、Curve、Balancer...）的报价
  - 用最优路径拆分订单，比如：你用 1000 USDC 换 ETH，直接去 Uniswap 可能 1.5% 滑点，但用 1inch 可能拆单到 Curve + Uniswap + SushiSwap，滑点降到 0.2%。
    1.   交易 1000 USDC → ETH

    2.   60% 从 Uniswap V3 获取

    3.   40% 从 Curve 获取
  - 一笔交易完成多跳、多池拆单，提高成交价格，减少滑点。
  -  对套利者意义：

  - 可以在聚合器和单一 DEX 间找价格差。
  - 可以用它的 API 做“多跳套利”，一次交易多次搬砖。
  -  聚合器的路径公开，你可以反向分析它们的交易逻辑，提前布局流动性或套利。例如：如果 1inch 经常在某币对走 V3 0.05% 池 → 说明这里交易量大，可考虑集中流动性挖手续费。

### 收益策略

#### **被动 LP 与主动 LP**

- **被动 LP**（类似 V2）：资金一直放在全区间，收益稳定，但资金利用率低。
- **主动 LP**（V3）：只在高交易密度区间挂单，资金利用率高，但需要频繁调整（rebalancing）。

**案例**： 假设 ETH 当前 $3000，历史价格 90% 时间在 $2800~$3200：

- 被动 LP：$100k 全区间（0 ~ ∞） → 平均年化 5%
- 主动 LP：同样资金集中在 $2800~$3200 → 手续费年化可能达 30%+，但如果价格跑出区间，收益立刻归零。

#### **窄区间 vs 宽区间**

- **窄区间**：高资金效率，但风险是价格出区间 → 无法赚手续费，需要调仓。
- **宽区间**：低效率，但稳定收取手续费，管理成本低。

公式（V3 资金效率提升倍数）：

$$资金效率提升倍数\approx \frac{全价格区间}{选择区间宽度}$$

例：全区间按 ETH $500 ~ $5000 计算，如果你只提供 $3000 ± 100：效率提升≈4500/200≈22.5倍

#### **LP Token 抵押复合策略**

1. **步骤**：
   1. 在 Uniswap 提供流动性 → 获得 LP Token
   2. 将 LP Token 抵押到借贷平台（Aave、Maker、Compound 支持的衍生协议）
   3. 借出稳定币再投入流动性，形成杠杆 LP。
2. **风险**：
   1. 双重风险（AMM 无常损失 + 杠杆清算风险）
   2. 利率反转时亏损放大。

### 治理与代币经济学

#### **UNI 代币分配**

- 初始分配：
  - 60% 社区（流动性挖矿、空投、社区资金池（未来激励））
  - 21.51% 团队
  - 17.8% 投资者（锁仓释放）
  - 0.69% 顾问
- 主要用途：
  - 治理投票（决定费率、激励方向、金库支出）。
  - 潜在手续费分红（目前治理未激活）。
- 总量 10 亿，4 年线性解锁。

#### **治理权**

- 持有 UNI 可：
  - 提案（需 1% UNI 总量）
  - 投票（治理费率、流动性激励、协议资金用途）
- 治理可直接决定：
  - Uniswap 不同池可以设不同费率（0.05%、0.3%、1%）。治理可调整以吸引 LP 或抑制套利者。
  - 哪些池子获得额外激励：可以投票用金库的 UNI 代币补贴特定交易对的 LP 收益。
  - **生态集成：**决定是否支持跨链部署、跟其他协议合作等。

**策略启发**：提前关注治理提案，比如某池将获得激励 → 资金提前布局，等激励生效时收割手续费 + 奖励。

## 价格预言机

### V2预言机-时间加权平均价格（TWAP）

V2 的设计里，Uniswap 本身不是为做预言机而生的，但它的合约储存了一些数据，可以用来**推导价格**。

**核心机制：**

- 每个交易对合约中有两个累计价格变量：price0CumulativeLast、price1CumulativeLast，这两个值表示「从池子创建开始，价格 × 时间」的累计和（单位：秒）。

每次区块有交易发生时，Uniswap 会：

1. 计算当前 `spot price`（现价 = reserve1 / reserve0）。
2. 用 `(当前价格 × 经过的时间秒数)` 累加到累计价格变量。

**WAP 公式：**

$$TWAP = \frac{\text{priceCumulativeLast}_{t2} - \text{priceCumulativeLast}_{t1}}{t_2 - t_1}$$

也就是两个时间点之间的价格差除以时间差，得到区间的平均价格。

**好处：**

- 不容易被闪电贷直接操纵，因为你得持续操纵多个区块的价格才能显著影响 TWAP。
- On-chain 用户可以直接读 Uniswap 合约来计算 TWAP，不需要链下数据源。

**缺陷：**

- 需要在两个不同区块分别调用才能获取有效 TWAP（不能一个区块内就完成计算）。
- 如果交易对长时间没人交易，累计值不会更新，需要外部喂价触发。

#### V3预言机-更高精度与多窗口

V3 保留了 V2 的累计价格机制，但做了三大改进：

1. **可配置的观测窗口** 每个交易对会记录多个历史价格观测点（`observations[]`），你可以直接在链上获取过去 N 秒、N 分钟、N 小时的 TWAP，方便开发者。
2. **更高精度的价格储存** 储存的是 √价格（`sqrtPriceX96`），精度更高（Q64.96 格式）。
3. **内置 Oracle 接口** 提供标准化方法 `observe()`，返回多个时间窗口的价格数据，降低开发难度。

**实际应用：**

- MakerDAO、Aave 等借贷协议会用 Uniswap TWAP 作为备用价格源。
- 某些链游或 NFT 市场用它来获取去中心化喂价。
- 不能直接用 spot price（现价），否则会被闪电贷操纵（前面你问过的第 2 个问题）。

#### 闪电贷操纵

假设某借贷协议用某个 Uniswap 池子的现价来判断抵押品价值：

1. 攻击者用闪电贷借来大量 Token A。
2. 在池子里用巨额 Token A 换 Token B，推高 A 的价格。
3. 借贷协议以为 A 涨了 → 攻击者用高估值的 A 抵押借出 Token B。
4. 攻击者立刻换回 Token A 还闪电贷，留下借到的 Token B。

**防御手段：**

- 使用 **TWAP 而不是现价**。
- 对喂价数据做「多源取中值」处理。
- 设置单笔借款额度限制（cap）。

## 智能合约

### V2 合约结构

- **Factory** 负责部署新交易对（Pair）合约，记录所有 Pair 地址。
- **Pair（核心逻辑）** 管理储备（reserve0, reserve1）、处理 swap/add/remove liquidity。
- **Router** 提供多跳交易、易用接口（实际资金转移还是进 Pair）。

### V3 合约结构

- **Factory**
- **Pool**（代替 V2 的 Pair，支持多费率、多区间流动性）
- **NFT Manager**（LP 头寸是 NFT，不再是同质化代币）
- **Swap Router**（多跳、多池交换）

### 安全风险

**价格操纵**

- 闪电贷+现价预言机 → 借贷协议被攻击。
- 防御：TWAP、多预言机、时间锁。

**重入攻击**

- 攻击合约在回调中再次调用目标函数，导致状态不一致。
- 防御：检查-效应-交互模式（Checks-Effects-Interactions）、重入锁。

**数学溢出/精度问题**

- V2 用 SafeMath 防溢出。
- V3 使用 Solidity 0.8 自带溢出检查 + Q64.96 高精度。

**资金托管漏洞**

- Router 不持有资金，减少被黑风险。
- 用户直接与 Pool 合约交互。

## 风险评估

1. 无常损失（Impermanent Loss）

- 当池子两种资产价格比例变化时，LP 持有的资产相较于单纯持币会减少价值。
- 例如：ETH/USDC 池，ETH 价格上涨时，你的 ETH 会变少。

2. 智能合约风险

- 虽然 V2 合约安全性较高，但永远有潜在漏洞（比如重入、价格操纵）。

3. 市场流动性风险

- 当大额交易冲击池子，价格会大幅滑点，LP 收益下降。

## 套利案例

#### 必会公式

1. **Uniswap V2（恒定乘积）交易输出**（带手续费 f=0.3%）：

- `amount_in_with_fee = amount_in * (1 - f)`（也常写作 `* 997/1000`）
- `amount_out = (amount_in_with_fee * Y) / (X + amount_in_with_fee)` （`X, Y` 为交易前的池子储备）

2. **Uniswap V2 无常损失（50/50 池）**：当某一侧价格变化倍数为 `r`（新价 / 旧价）

1.  $$IL(r)= \frac{2\sqrt{r}}{1 + r}$$

（`IL` 为相对 HODL 的损失比例，通常为负数）

3. **Uniswap V3 — 在区间内的头寸** 设 `sqrtP = sqrt(price)`, `sqrtPa = sqrt(Pa)`, `sqrtPb = sqrt(Pb)`，流动性 `L` 则：

- `amount0 (token0)`（例如 ETH）：

$$amount0=L \cdot \frac{\sqrt{P_b} - \sqrt{P}}{\sqrt{P} \cdot \sqrt{P_b}}$$

- `amount1 (token1)`（例如 USDC）：

$$amount1= L \cdot (\sqrt{P} - \sqrt{P_a})$$

- 反解（从 amount1 得到 L）：

$$L=\frac{amount1}{\sqrt{P} - \sqrt{P_a}}$$

#### 价格翻倍时的 IL 与手续费

假设：

- 初始：1 ETH @ 2000 USDC + 2000 USDC（总价值 4000 USDC），你作为 LP（等值两边）。
- ETH 价格上涨到 4000（`r = 2`）。 计算：
- HODL 最终价值 = 1 * 4000 + 2000 = 6000 USDC
- IL(r=2) ≈ `2*sqrt(2)/(1+2) - 1 ≈ -0.0572` → LP 相对 HODL 损失 5.72%
- LP 最终价值（不含手续费） = 6000 * (1 - 0.0572) ≈ 5,656.8 USDC
- 若在同一时期手续费总计等于原始 TVL 的 5%（举例），对你的份额产生 200 USDC 的额外收益：
  - LP 含费最终 ≈ 5,656.8 + 200 = 5,856.8 USDC
  - 仍低于 HODL 的 6,000 USDC → 手续费没完全覆盖 IL（净落后 143.2 USDC）

**结论**：当单边资产大幅上涨时（或下跌），IL 可能吞掉大部分收益；是否“被手续费覆盖”取决于手续费率、交易量和时间窗口。

#### 宽窄区间

假设：

- 池年总交易量 10,000,000 USDC，fee=0.3% → 总手续费 30,000 USDC/年。
- 你以 4,000 USDC 进入池子（1 ETH + 2000 USDC），在 V2 上你的 TVL 占比很小，假设占比 0.1% → 年手续费 ≈ 30 USDC。
- 在 V3 你把资金集中在“高频区间”，该区间只占全市场活跃流动性的 2%，但此区间承担了 50% 的交易量（热区）。如果你在该区间的占比是 5%（因为集中），你可分到：`30,000 * 0.5 * 5% = 750 USDC`，比 V2 的 30USDC 高很多。

**结论**：集中流动性能显著提高手续费收入（资本效率），但会带来“区间外失效”与更高的管理需求。

## 套利注意

任何套利都必须扣除：链上 Gas、闪电贷费用、滑点、前置失败风险（被 Miner/Builder 抢先）、回滚成本。

在主网竞价（MEV）场景下，要么付更高 gas（不一定成功），要么使用 Flashbots Bundle 提交 bundle 给矿工私下打包，避免被三明治或前置抢掉。

在计算套利是否可执行前，先在本地 fork 的主网（hardhat/foundry）上模拟并 measure gas cost。

当池子深度大、差价小、gas 高时，很多看起来有利润的机会实际上因为 gas/fee 而无利可图。

编写合约时务必加上检查：校验池子储备在预期窗口内是否变化、最小接受收益阈值（slippage protection）、验证调用来源（onlyPair）等。

## 专业研究员必须掌握的 V2 知识清单

1. **AMM 恒定乘积公式推导与应用**（能算滑点、价格变化、套利利润）。
2. **LP 收益与无常损失计算**（懂得何时退出/换池）。
3. **TWAP 预言机读取与攻击原理**（懂得防范闪电贷操纵）。
4. **闪电交换实现与应用**（会用 flash swap 做套利、清算）。
5. **流动性迁移逻辑**（V2→V3 或跨平台迁移）。
6. **链上数据分析能力**（能从 Dune、Flipside 抓取池子数据做策略）。

## 未来趋势

### Uniswap V4

Uniswap V4 主要引入了一个非常重要的概念：**Hooks（钩子）** 和 **统一的流动性层（Singleton Pool）**。

#### **Hooks（钩子）**

> Hooks 本质上让 Uniswap 从一个固定逻辑的 DEX，变成了一个 **可编程流动性平台**。

- Hooks 是一种允许开发者在流动性池生命周期的关键节点插入自定义逻辑的机制。
- 关键节点包括：BeforeInitialize（初始化池子前）、AfterInitialize、BeforeSwap、AfterSwap、BeforeAddLiquidity、AfterAddLiquidity、BeforeRemoveLiquidity、AfterRemoveLiquidity
- 可以用 Hooks 实现：**动态费率**（根据波动率自动调节手续费）、**自动复利**（LP 收益自动再投入）、**MEV 防护**（如只允许某些白名单交易者）、**限价单池**（实现链上原生限价挂单）、**链上自动化策略**（比如 TWAP 自动执行）

#### **统一的流动性层（Singleton Pool）**

- V2 / V3 每个交易对池子是一个独立合约，部署成本高、Gas 开销大。
- V4 采用单合约存储多个池子的设计：
  - 所有池子共享一个合约（Singleton）
  - 流动性存储使用 **“存储槽”（Storage Slot）** 来区分不同池子
  - 创建新池不再需要部署新合约 → 大幅降低 Gas 成本
  - 组合交易（多池 swap）会更便宜

#### 潜在策略

- **自定义费率池**：可以根据波动率或交易量动态调节手续费，赚取更多套利者的费用。
- **链上限价单**：用 Hook 自动撤单 / 挂单，在 DeFi 内原生实现 CEX 功能。
- **自动再平衡 LP 策略**：Hook 在价格触发阈值时自动调整区间，减少无常损失。
- **链上 TWAP / VWAP 执行**：用 Hook 自动分批执行大额订单，减少滑点和被抢跑的风险。

### 多链与 Layer 2 布局

Uniswap 目前已经部署到：以太坊主网、Polygon、Optimism、Arbitrum、Base、BSC（通过治理投票引入）、Avalanche、Celo 等

意义：

- 捕捉不同链的交易流量（尤其是低费率环境的长尾交易）
- 防止竞争对手占据市场份额（Curve、Sushi、Pancake 都在多链）
- Layer 2 扩展：在低 Gas、高 TPS 的环境吸引做市商和高频交易者

Layer 2 布局逻辑

- **Optimistic Rollup**（Optimism、Arbitrum）
  - 成本低，交易快
  - 对低滑点、大宗交易友好
- **ZK Rollup**（zkSync、StarkNet 未来可能）
  - 更快结算、更安全
  - 有望吸引机构流动性
- **策略机会**：
  - L2 上做高频区间再平衡 LP（在主网会被 Gas 吃掉利润）
  - 跨链套利（例如 ETH 在主网和 Arbitrum 之间的价格差）
  - 利用低费率环境做 TWAP / VWAP 大单执行

#### 趋势总结

- **V4 是模块化 DEX 时代的开始** 从“一个交易所”变成“一个流动性平台”，允许社区在其上开发各种玩法（类似 DeFi App Store）。
- **多链布局让 Uniswap 不再是“以太坊独占”** 而是变成了多链流动性中心，未来可能会和跨链桥深度绑定。
- **策略思路变化**： 从“单纯被动 LP” → “主动、可编程 LP”，赚的不只是手续费，还可能是自定义逻辑带来的额外收益。

## 问题

### 侧链Sidechain vs layer2

**核心区别**在于——**是否依赖主链安全性**

- **侧链**：独立的区块链，自己负责共识和安全，和以太坊通过跨链桥进行资产转移。
- **Layer 2**：构建在以太坊之上，**安全性依赖以太坊主链**，只是把交易执行放到链外，提高吞吐量和降低Gas。

| 对比项     | 侧链（Sidechain）    | Layer 2                    |
| ---------- | -------------------- | -------------------------- |
| 安全性来源 | 自己的节点和共识机制 | 以太坊主链                 |
| 与主链关系 | 独立运行，通过桥连接 | 附属于主链                 |
| 交易速度   | 高                   | 高                         |
| 资产安全   | 取决于侧链自身安全   | 基本等同于以太坊安全性     |
| 例子       | Polygon PoS、xDAI    | Arbitrum、Optimism、zkSync |

侧链像“邻居小区”，有自己物业、自己的门禁，搬家过去要过桥，但那里的治安好不好要看物业本身。

Layer 2 像“高层公寓的电梯”，你依然住在同一个小区（以太坊），只是上楼的方式更快更便宜。

### Optimistic Rollup vs ZK Rollup

它们都是 **Rollup**（批量打包交易后上链）的两种实现方式。 核心思想：把大量交易放到链下执行，只把摘要（结果）提交到以太坊，从而省Gas。

#### Optimistic Rollup（乐观卷叠）

- **原理**：假设（乐观地认为）链下提交的交易数据都是正确的，只有在有人怀疑时，才通过欺诈证明（Fraud Proof）进行验证。
- **优点**：实现简单，兼容EVM好，迁移现有DApp方便。
- **缺点**：提款需要等待挑战期（通常 7 天左右），因为要留时间让别人发现并提出欺诈。

**代表项目**：Optimism、Arbitrum

#### ZK Rollup（零知识卷叠）

- **原理**：每批交易提交时，同时附带一个**零知识证明（Validity Proof）**，用数学证明这批交易是正确的。
- **优点**：无需等待挑战期，提款速度快；安全性很高。
- **缺点**：生成零知识证明的计算复杂，对EVM兼容性差（但zkEVM正在解决这个问题）。

**代表项目**：zkSync、StarkNet、Polygon zkEVM

| 对比项   | Optimistic Rollup | ZK Rollup         |
| -------- | ----------------- | ----------------- |
| 验证方式 | 欺诈证明          | 零知识证明        |
| 安全依赖 | 以太坊            | 以太坊            |
| 提款速度 | 慢（挑战期）      | 快                |
| EVM 兼容 | 高                | 低（zkEVM后提高） |
| 计算开销 | 低                | 高                |